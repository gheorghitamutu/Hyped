@page "/login"
@inject HttpClient Http
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Components.Authorization
@inject DummyAuthStateProvider DummyAuthStateProvider
@using Newtonsoft.Json.Linq
@using Auth;
@using Microsoft.IdentityModel.Tokens;
@using System.IdentityModel.Tokens.Jwt;
@inject Blazored.LocalStorage.ILocalStorageService sessionStorage

<div class="jumbotron" style="width: 100%; height: 100%; position: fixed; display: block; top: 0px; left: 0px; float: none; text-align: center;">
    <h1 class="display-3">Sign In!<br></h1>
    <p class="lead">Fill in you account details:<br></p>
    <hr class="my-4">
    <div class="row" style="">
        <div class=" col-6">
            <h3>Email:</h3>
        </div>
        <div class="  col-6">
            <input type="text" placeholder="Enter Email" @bind="the_account.Email" name="email" required><br /><br />
        </div>
    </div>
    <hr style="">
    <div class="row" style="">
        <div class=" col-6">
            <h3>Password:<br></h3>
        </div>
        <div class="  col-6">
            <input type="password" placeholder="Enter Password" @bind="the_account.Password" name="psw" required><br /><br />
        </div>
    </div>
    <hr style="">
    <div class="row" style="">
        <div class=" col-6">
            <button type="button" @onclick="@(()=>Sign_in())" class="btn btn-primary" style="display: inline-block; width: 15rem;">Sign In</button>
        </div>
        <div class="  col-6">
            <button type="button" @onclick="Back" class="btn btn-primary" style="width: 15rem;">Back</button>
        </div>
    </div>
    <hr style="">
    <div class="row" style="">
        <div class=" col-6 ">
            <h4>Join Hyped today!<br></h4>
        </div>
        <div class="  col-6">
            <button @onclick="Register" type="button" class="btn btn-primary" style="text-decoration-color: rgb(255, 128, 0); background-color: rgb(255, 128, 0); width: 15rem;">JOIN NOW!</button>
        </div>
    </div>
</div>




@code {

    private string apiUrl = "https://localhost:44386/api/users/login";
    Response response;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }

    private Request the_account = new Request();

    private async Task SendCredentials()
    {
        response = await Http.PostJsonAsync<Response>(apiUrl, the_account);
        System.Console.WriteLine(response.token);
    }

    private async Task UpdateAuthentication(string token)
    {
        
        DummyAuthStateProvider.token = token;
        await DummyAuthStateProvider.NotifyStateChange();
    }

    private async Task Sign_in()
    {
        await SendCredentials();
        await UpdateAuthentication(response.token);
        await sessionStorage.SetItemAsync("token", response.token);
        var name = await sessionStorage.GetItemAsync<string>("token");

        NavigationManager.NavigateTo("");
    }

    private void Back()
    {
        NavigationManager.NavigateTo("");
    }

    private void Register()
    {
        NavigationManager.NavigateTo("/register");
    }

    public class Request
    {

        public string Email { get; set; }

        public string Password { get; set; }
    }

    public class Response
    {
        public string token { get; set; }
    }

    public class VM
    {
        public Guid VMId { get; set; }
        public string RealID { get; set; }
        public string Name { get; set; }
        public string Configuration { get; set; }
        public string LastSave { get; set; }
        public Guid UserId { get; set; }
    }

}
